//const BASE_URL = 'https://dummyjson.com';

//export const fetchPosts = async () => {
//    try {
//        const response = await fetch(`${BASE_URL}/posts`);
//        if (!response.ok) throw new Error('Network response was not ok');
//        const data = await response.json();
//        return data.posts; // Access the posts array
//    } catch (error) {
//        console.error('Fetch error:', error);
//        return [];
//    }
//};

//// Call the fetchPosts function to see the output
//fetchPosts().then(posts => {
//    console.log(posts); // Log the posts to see the output
//});


import { fetchPosts, createPost, updatePost } from './api.js';
import { loadPostsFromLocalStorage, savePostsToLocalStorage } from './storage.js';

let allPosts = [];

// Load posts from local storage
allPosts = loadPostsFromLocalStorage();

// Display posts from local storage on initial load
displayPosts(allPosts);

document.getElementById('load-btn').addEventListener('click', async () => {
    const fetchedPosts = await fetchPosts();
    allPosts = [...loadPostsFromLocalStorage(), ...fetchedPosts.filter(post => !allPosts.find(p => p.id === post.id))];
    savePostsToLocalStorage(allPosts);
    displayPosts(allPosts);
});

// Function to display posts in the UI
const displayPosts = (posts) => {
    const postsContainer = document.getElementById('posts');
    postsContainer.innerHTML = ''; // Clear previous posts

    posts.forEach(post => {
        const postElement = document.createElement('div');
        postElement.className = 'post';
        postElement.innerHTML = `
            <h3>${post.title}</h3>
            <p>${post.body}</p>
            <button class="edit-btn" data-id="${post.id}">Edit</button>
        `;
        postsContainer.appendChild(postElement);
    });

    // Add event listeners to edit buttons
    const editButtons = document.querySelectorAll('.edit-btn');
    editButtons.forEach(button => {
        button.addEventListener('click', () => {
            const postId = button.getAttribute('data-id');
            const postToEdit = allPosts.find(p => p.id === parseInt(postId));
            document.getElementById('title').value = postToEdit.title;
            document.getElementById('body').value = postToEdit.body;

            // Update the add button to update post
            const addButton = document.getElementById('add-btn');
            addButton.textContent = 'Update Post';
            addButton.setAttribute('data-id', postId);
        });
    });
};

// Event listener to add/update a post
document.getElementById('add-btn').addEventListener('click', async () => {
    const title = document.getElementById('title').value;
    const body = document.getElementById('body').value;
    const addButton = document.getElementById('add-btn');

    if (title && body) {
        if (addButton.getAttribute('data-id')) {
            // Update post
            const postId = addButton.getAttribute('data-id');
            const updatedPost = await updatePost(postId, title, body);
            if (updatedPost) {
                allPosts = allPosts.map(post => (post.id === parseInt(postId) ? updatedPost : post));
                savePostsToLocalStorage(allPosts);
                displayPosts(allPosts);
                resetForm();
            }
        } else {
            // Create new post
            const newPost = await createPost(title, body);
            if (newPost) {
                allPosts.unshift(newPost);
                savePostsToLocalStorage(allPosts);
                displayPosts(allPosts);
                resetForm();
            }
        }
    } else {
        alert('Please fill in both fields');
    }
});

// Reset form function
const resetForm = () => {
    document.getElementById('title').value = '';
    document.getElementById('body').value = '';
    const addButton = document.getElementById('add-btn');
    addButton.textContent = 'Add Post';
    addButton.removeAttribute('data-id');
};

// Event listener for searching posts based on title
document.getElementById('search-btn').addEventListener('click', () => {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const filteredPosts = allPosts.filter(post =>
        post.title.toLowerCase().includes(searchTerm) || post.body.toLowerCase().includes(searchTerm)
    );
    displayPosts(filteredPosts);
});
